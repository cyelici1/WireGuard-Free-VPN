name: Personal Secure VPN (WireGuard)

on:
  # ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ (Trigger) Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ú©Ù…Ù‡ "Run Workflow" Ø¯Ø± GitHub Actions
  workflow_dispatch:

jobs:
  vpn:
    # Ø§Ø¬Ø±Ø§ Ø±ÙˆÛŒ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø§ÙˆØ¨ÙˆÙ†ØªÙˆ
    runs-on: ubuntu-latest
    # ØªÙ†Ø¸ÛŒÙ… Ø­Ø¯Ø§Ú©Ø«Ø± Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ Ø¨Ù‡ 360 Ø¯Ù‚ÛŒÙ‚Ù‡ (6 Ø³Ø§Ø¹Øª)
    timeout-minutes: 360

    steps:
      - name: Update & install packages
        run: |
          sudo apt update -y
          # Ù†ØµØ¨ WireGuardØŒ qrencode (Ø¨Ø±Ø§ÛŒ QR Ú©Ø¯)ØŒ curl Ùˆ iptables-persistent
          sudo apt install -y wireguard qrencode curl iptables-persistent

      - name: Prepare workspace & Generate New Keys
        run: |
          mkdir -p $HOME/wg
          cd $HOME/wg
          
          # Ø³Ø§Ø®Øª Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ Ø®ØµÙˆØµÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨Ø§Ø± Ø§Ø¬Ø±Ø§ (Ø§Ù…Ù† Ùˆ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ)
          umask 077
          wg genkey | tee server_private.key | wg pubkey > server_public.key
          wg genkey | tee client_private.key | wg pubkey > client_public.key
          chmod 600 server_private.key client_private.key
          echo "âœ… New keys generated."
          echo " "

      - name: Build server and client configs
        run: |
          cd $HOME/wg
          WG_IF=wg0
          WG_PORT=51820
          # Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ IP Ø¹Ù…ÙˆÙ…ÛŒ Ø³Ø±ÙˆØ± Ù…Ø¬Ø§Ø²ÛŒ GitHub
          WG_HOST=$(curl -s icanhazip.com) 

          SERVER_PRIV=$(cat server_private.key)
          SERVER_PUB=$(cat server_public.key)
          CLIENT_PUB=$(cat client_public.key)
          
          # Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø³Ø±ÙˆØ± (wg0.conf) Ùˆ Ø§Ø¹Ù…Ø§Ù„ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ sudo
          cat << CONF | sudo tee /etc/wireguard/wg0.conf
[Interface]
PrivateKey = ${SERVER_PRIV}
Address = 10.0.0.1/24
ListenPort = ${WG_PORT}
PostUp = iptables -A FORWARD -i ${WG_IF} -j ACCEPT; iptables -A FORWARD -o ${WG_IF} -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i ${WG_IF} -j ACCEPT; iptables -D FORWARD -o ${WG_IF} -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
PublicKey = ${CLIENT_PUB}
AllowedIPs = 10.0.0.2/32
CONF
          
          # Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù„Ø§ÛŒÙ†Øª (client.conf)
          cat << CLIENT_CONF > client.conf
[Interface]
PrivateKey = $(cat client_private.key)
Address = 10.0.0.2/24
DNS = 8.8.8.8

[Peer]
PublicKey = ${SERVER_PUB}
Endpoint = ${WG_HOST}:${WG_PORT}
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
CLIENT_CONF

          echo "âœ… Configuration files built."
          echo " "

      - name: Start WireGuard and show config
        run: |
          # ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ IP Forwarding (Ø¶Ø±ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ VPN)
          sudo sysctl -w net.ipv4.ip_forward=1
          # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ WireGuard
          sudo wg-quick up wg0
          
          echo " "
          echo "âœ… WireGuard VPN server is running on IP: ${WG_HOST}:${WG_PORT}"
          echo "ğŸ“± QR code for quick import (Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯):"
          # Ù†Ù…Ø§ÛŒØ´ QR code Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† Ù…Ø³ØªÙ‚ÛŒÙ…
          qrencode -t ansiutf8 < $HOME/wg/client.conf
          echo " "
          echo "â—ï¸ Ø³Ø±ÙˆØ± ØªØ§ Ø­Ø¯ÙˆØ¯ 6 Ø³Ø§Ø¹Øª Ø¯ÛŒÚ¯Ø± Ø®Ø§Ù…ÙˆØ´ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ ØªÙ…Ø¯ÛŒØ¯ØŒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¯Ú©Ù…Ù‡ Run Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯."

      # Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Artifact Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
      - name: Upload client config (for download)
        uses: actions/upload-artifact@v4
        with:
          name: wireguard-client-config
          path: $HOME/wg/client.conf

      # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø³Ø±ÙˆØ± Ø¨Ù‡ Ù…Ø¯Øª Ø²Ù…Ø§Ù† timeout-minutes Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª.
      - name: Keep job alive (Sleep)
        run: |
          echo "Keeping the VPN server alive for the remaining time..."
          # 355 Ø¯Ù‚ÛŒÙ‚Ù‡ (5 Ø³Ø§Ø¹Øª Ùˆ 55 Ø¯Ù‚ÛŒÙ‚Ù‡) Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Timeout
          sleep 355m
