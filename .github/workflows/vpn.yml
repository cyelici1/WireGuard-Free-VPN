name: WireGuard VPN (Guaranteed Fix)

on:
  workflow_dispatch:

jobs:
  run-vpn:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: System Setup and Key Generation
        id: setup
        run: |
          sudo apt update -y
          sudo apt install -y wireguard qrencode curl iptables-persistent net-tools
          
          umask 077
          WG_HOST=$(curl -s icanhazip.com)
          
          # ØªÙˆÙ„ÛŒØ¯ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù…
          SERVER_PRIV=$(wg genkey)
          CLIENT_PRIV=$(wg genkey)
          
          # Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ùˆ IP Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Ù…Ø±Ø­Ù„Ù‡
          echo "SERVER_PRIV=$SERVER_PRIV" >> $GITHUB_OUTPUT
          echo "CLIENT_PRIV=$CLIENT_PRIV" >> $GITHUB_OUTPUT
          echo "SERVER_PUB=$(echo $SERVER_PRIV | wg pubkey)" >> $GITHUB_OUTPUT
          echo "WG_HOST=$WG_HOST" >> $GITHUB_OUTPUT

      - name: Create Configuration Files (Single Step)
        env:
          SP: ${{ steps.setup.outputs.SERVER_PRIV }}
          CP: ${{ steps.setup.outputs.CLIENT_PRIV }}
          CPUB: $(echo ${{ steps.setup.outputs.CLIENT_PRIV }} | wg pubkey) # Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ…
          SPUB: ${{ steps.setup.outputs.SERVER_PUB }}
          HOST: ${{ steps.setup.outputs.WG_HOST }}
          
          # Ø«Ø§Ø¨Øª Ù‡Ø§
          WG_PORT: 51820
          WG_IF: wg0
          
        run: |
          mkdir -p $HOME/wg
          
          # Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯ Ø³Ø±ÙˆØ± (Ø¨Ø¯ÙˆÙ† ÙØ¶Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø¶Ø§ÙÛŒ)
          sudo sh -c "echo \"[Interface]\" > /etc/wireguard/wg0.conf"
          sudo sh -c "echo \"PrivateKey = $SP\" >> /etc/wireguard/wg0.conf"
          sudo sh -c "echo \"Address = 10.0.0.1/24\" >> /etc/wireguard/wg0.conf"
          sudo sh -c "echo \"ListenPort = $WG_PORT\" >> /etc/wireguard/wg0.conf"
          # ØªÙ†Ø¸ÛŒÙ…Ø§Øª IPTable
          sudo sh -c "echo \"PostUp = iptables -A FORWARD -i $WG_IF -j ACCEPT; iptables -A FORWARD -o $WG_IF -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; sysctl -w net.ipv4.ip_forward=1\" >> /etc/wireguard/wg0.conf"
          sudo sh -c "echo \"PostDown = iptables -D FORWARD -i $WG_IF -j ACCEPT; iptables -D FORWARD -o $WG_IF -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE\" >> /etc/wireguard/wg0.conf"
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Peer Ø¨Ù‡ ØµÙˆØ±Øª Ø§ÛŒÙ…Ù†
          sudo sh -c "echo \"\" >> /etc/wireguard/wg0.conf"
          sudo sh -c "echo \"[Peer]\" >> /etc/wireguard/wg0.conf"
          sudo sh -c "echo \"PublicKey = $CPUB\" >> /etc/wireguard/wg0.conf" # Ø§ÛŒÙ† Ø®Ø· Ù‚Ø¨Ù„Ø§ Ø®Ø·Ø§ Ù…ÛŒØ¯Ø§Ø¯
          sudo sh -c "echo \"AllowedIPs = 10.0.0.2/32\" >> /etc/wireguard/wg0.conf"


          # Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù„Ø§ÛŒÙ†Øª
          echo "[Interface]" > $HOME/wg/client.conf
          echo "PrivateKey = $CP" >> $HOME/wg/client.conf
          echo "Address = 10.0.0.2/24" >> $HOME/wg/client.conf
          echo "DNS = 8.8.8.8, 1.1.1.1" >> $HOME/wg/client.conf
          echo "" >> $HOME/wg/client.conf
          echo "[Peer]" >> $HOME/wg/client.conf
          echo "PublicKey = $SPUB" >> $HOME/wg/client.conf
          echo "Endpoint = $HOST:$WG_PORT" >> $HOME/wg/client.conf
          echo "AllowedIPs = 0.0.0.0/0" >> $HOME/wg/client.conf
          echo "PersistentKeepalive = 25" >> $HOME/wg/client.conf

      - name: Start WireGuard and Display Config
        env:
          WG_HOST: ${{ steps.setup.outputs.WG_HOST }}
        run: |
          sudo wg-quick up wg0
          
          echo " "
          echo "--------------------------------------------------------"
          echo "âœ… VPN Server is Ready on IP: $WG_HOST:51820"
          echo "--------------------------------------------------------"
          echo " "
          echo "ðŸ“± Scan the QR Code below to connect:"
          echo " "
          qrencode -t ansiutf8 < $HOME/wg/client.conf
          echo " "
          
      - name: Keep job alive (Sleep)
        run: |
          echo "Server will stay alive for 6 hours. To extend, run the workflow again."
          sleep 355m
