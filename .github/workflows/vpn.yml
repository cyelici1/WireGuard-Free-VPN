name: WireGuard VPN (Final Working Code)

on:
  workflow_dispatch:

jobs:
  run-vpn:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: System Setup and Key Generation
        id: setup
        run: |
          sudo apt update -y
          sudo apt install -y wireguard qrencode curl iptables-persistent net-tools
          
          umask 077
          WG_HOST=$(curl -s icanhazip.com)
          
          SERVER_PRIV=$(wg genkey)
          CLIENT_PRIV=$(wg genkey)
          
          echo "SERVER_PRIV=$SERVER_PRIV" >> $GITHUB_OUTPUT
          echo "CLIENT_PRIV=$CLIENT_PRIV" >> $GITHUB_OUTPUT
          echo "SERVER_PUB=$(echo $SERVER_PRIV | wg pubkey)" >> $GITHUB_OUTPUT
          echo "CLIENT_PUB=$(echo $CLIENT_PRIV | wg pubkey)" >> $GITHUB_OUTPUT
          echo "WG_HOST=$WG_HOST" >> $GITHUB_OUTPUT

      - name: Create Configuration Files
        env:
          SP: ${{ steps.setup.outputs.SERVER_PRIV }}
          CP: ${{ steps.setup.outputs.CLIENT_PRIV }}
          SPUB: ${{ steps.setup.outputs.SERVER_PUB }}
          CPUB: ${{ steps.setup.outputs.CLIENT_PUB }}
          HOST: ${{ steps.setup.outputs.WG_HOST }}
          
          WG_PORT: 51820
          WG_IF: wg0
          
        run: |
          mkdir -p $HOME/wg
          
          # Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯ Ø³Ø±ÙˆØ± (PostUp/PostDown Ø­Ø°Ù Ø´Ø¯Ù†Ø¯ ØªØ§ Ø¯Ø± Bash Ø§Ø¬Ø±Ø§ Ø´ÙˆÙ†Ø¯ Ùˆ Ø®Ø·Ø§ÛŒ Rx: 0B Ø­Ù„ Ø´ÙˆØ¯)
          echo "[Interface]" > server.temp
          echo "PrivateKey = $SP" >> server.temp
          echo "Address = 10.0.0.1/24" >> server.temp
          echo "ListenPort = $WG_PORT" >> server.temp
          echo "" >> server.temp
          echo "[Peer]" >> server.temp
          echo "PublicKey = $CPUB" >> server.temp
          echo "AllowedIPs = 10.0.0.2/32" >> server.temp
          
          # Ø­Ø°Ù ÙØ¶Ø§Ù‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ùˆ Ú©Ù¾ÛŒ Ø¯Ø± Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ
          awk 'NF' server.temp | sudo tee /etc/wireguard/wg0.conf

          # Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù„Ø§ÛŒÙ†Øª (Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ/Ù¾ÛŒØ³Øª Ùˆ QR)
          echo "[Interface]" > $HOME/wg/client.conf
          echo "PrivateKey = $CP" >> $HOME/wg/client.conf
          echo "Address = 10.0.0.2/24" >> $HOME/wg/client.conf
          echo "DNS = 8.8.8.8, 1.1.1.1" >> $HOME/wg/client.conf
          echo "" >> $HOME/wg/client.conf
          echo "[Peer]" >> $HOME/wg/client.conf
          echo "PublicKey = $SPUB" >> $HOME/wg/client.conf
          echo "Endpoint = $HOST:$WG_PORT" >> $HOME/wg/client.conf
          echo "AllowedIPs = 0.0.0.0/0" >> $HOME/wg/client.conf
          echo "PersistentKeepalive = 25" >> $HOME/wg/client.conf

      - name: Start WireGuard and Setup Firewall
        env:
          WG_HOST: ${{ steps.setup.outputs.WG_HOST }}
          WG_IF: wg0
          
        run: |
          # ğŸ’¡ Ø§Ø¬Ø±Ø§ÛŒ sysctl Ù‚Ø¨Ù„ Ø§Ø² wg-quick
          sudo sysctl -w net.ipv4.ip_forward=1
          sudo wg-quick up wg0
          
          # ğŸ’¡ Ø§Ø¬Ø±Ø§ÛŒ Ù‚Ø·Ø¹ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª NAT Ùˆ ÙØ§ÛŒØ±ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ø² Ø´Ø±ÙˆØ¹ wg0
          sudo iptables -A FORWARD -i ${WG_IF} -j ACCEPT
          sudo iptables -A FORWARD -o ${WG_IF} -j ACCEPT
          sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          
          echo " "
          echo "--------------------------------------------------------"
          echo "âœ… VPN Server is Ready. Copy the config below."
          echo "--------------------------------------------------------"
          
          echo "ğŸ“„ Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ø§Ù…Ù„ client.conf (Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ/Ù¾ÛŒØ³Øª Ø³Ø§Ø¯Ù‡):"
          echo " "
          cat $HOME/wg/client.conf
          echo " "
          
          echo "ğŸ“± QR Code (Ù‚Ø§Ø¨Ù„ Ø§Ø³Ú©Ù† Ù†ÛŒØ³ØªØŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´):"
          qrencode -t ansiutf8 < $HOME/wg/client.conf
          echo " "
          
      - name: Keep job alive (Sleep)
        run: |
          echo "Server will stay alive for 6 hours. To extend, run the workflow again."
          sleep 355m
